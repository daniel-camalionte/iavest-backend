name: Deploy STG

on:
  push:
    branches:
      - stg

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: stg

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Debug FTP
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
        run: |
          printf '%s\n' \
            'import ftplib, os' \
            'host = os.environ["FTP_HOST"]' \
            'user = os.environ["FTP_USER"]' \
            'password = os.environ["FTP_PASS"]' \
            'ftp = ftplib.FTP()' \
            'ftp.set_debuglevel(2)' \
            'ftp.connect(host, 21, timeout=30)' \
            'ftp.login(user, password)' \
            'import io' \
            'try:' \
            '    ftp.storbinary("STOR test_visivel.txt", io.BytesIO(b"hello from github actions"))' \
            '    print("=== STOR raiz OK")' \
            'except Exception as e:' \
            '    print("=== STOR raiz FALHOU:", e)' \
            'try:' \
            '    ftp.storbinary("STOR apps_wsgi/stg/test_visivel.txt", io.BytesIO(b"hello from github actions"))' \
            '    print("=== STOR apps_wsgi/stg OK")' \
            'except Exception as e:' \
            '    print("=== STOR apps_wsgi/stg FALHOU:", e)' \
            'ftp.quit()' \
            > /tmp/ftp_debug.py
          python3 /tmp/ftp_debug.py
