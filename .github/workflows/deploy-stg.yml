name: Deploy STG

on:
  push:
    branches:
      - stg

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: stg

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Install lftp
        run: sudo apt-get install -y lftp

      - name: Upload via FTP
        run: |
          lftp -e "
            set ftp:ssl-allow no;
            set net:timeout 30;
            open -u '${{ secrets.FTP_USER }}','${{ secrets.FTP_PASSWORD }}' ${{ secrets.FTP_HOST }};
            mirror -R --delete --verbose \
              --exclude-glob .git* \
              --exclude-glob virtual_env/ \
              --exclude-glob dump/ \
              --exclude-glob __pycache__/ \
              --exclude-glob '*.pyc' \
              --exclude-glob static/ \
              --exclude-glob image/ \
              --exclude-glob .env \
              --exclude-glob .claude/ \
              --exclude-glob .github/ \
              --exclude-glob .vscode/ \
              ./ /home/iavest/apps_wsgi/stg/;
            quit
          "

      - name: Reload app e atualiza Swagger
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            # Reinicia a aplicação
            touch ~/apps_wsgi/stg.wsgi

            # Aguarda o app reiniciar e gerar o swagger.json
            sleep 5

            # Atualiza o basePath no swagger.json
            SWAGGER=~/apps_wsgi/stg/static/swagger.json
            if [ -f "$SWAGGER" ]; then
              python3 -c "import json; data=json.load(open('$SWAGGER')); data['basePath']='/stg'; json.dump(data, open('$SWAGGER','w'), indent=2)"
              echo "Swagger atualizado com basePath=/stg"
            else
              echo "swagger.json ainda nao existe, sera atualizado no proximo deploy"
            fi
