name: Deploy STG

on:
  push:
    branches:
      - stg

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: stg

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Install lftp
        run: sudo apt-get install -y lftp

      - name: Upload via FTP
        run: |
          lftp -e "
            set ftp:ssl-allow no;
            set net:timeout 30;
            open -u '${{ secrets.FTP_USER }}','${{ secrets.FTP_PASSWORD }}' ${{ secrets.FTP_HOST }};
            pwd;
            ls -la;
            cd apps_wsgi;
            pwd;
            ls -la;
            quit
          "
          echo '--- FIM DEBUG ---'
          lftp -e "
            set ftp:ssl-allow no;
            set net:timeout 30;
            open -u '${{ secrets.FTP_USER }}','${{ secrets.FTP_PASSWORD }}' ${{ secrets.FTP_HOST }};
            cd /apps_wsgi/stg;
            mirror -R --verbose \
              --exclude-glob .git \
              --exclude-glob .git/ \
              --exclude-glob virtual_env/ \
              --exclude-glob dump/ \
              --exclude-glob __pycache__/ \
              --exclude-glob '*.pyc' \
              --exclude-glob static/ \
              --exclude-glob image/ \
              --exclude-glob .env \
              --exclude-glob .claude/ \
              --exclude-glob .github/ \
              --exclude-glob .vscode/ \
              . .;
            quit
          "
